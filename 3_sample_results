
// var SAMPLE = ee.FeatureCollection('projects/ee-valeriepasquarella/assets/HF-GM/PlotDefHarvSimple')
var SAMPLE = ee.FeatureCollection('projects/ee-valeriepasquarella/assets/CT-GM/FEN_BurlapSurvey_Coords')
var EXPERIMENTS = ee.ImageCollection('projects/sites-project/conditionassessment_experiments_v5-2_results')

var YEAR = 2017

var selectedExperiments = EXPERIMENTS.filterMetadata('monitor_year', 'equals', YEAR)

var reanalysis_cn = 'reanalysis_' + YEAR
if (YEAR >= 2015 & YEAR <= 2018) {
  var reanalysis_fn = 'projects/ee-valeriepasquarella/assets/ForestCondition/' + YEAR + '_reanalysis_meanresiduals'
  var reanalysis = ee.Image(reanalysis_fn).reproject('EPSG:5070').rename(reanalysis_cn)
} else {
  var reanalysis = ee.Image.constant(99).rename(reanalysis_cn)
}
print(reanalysis)

// function to convert image collection into stack of image bands
function collectionToImage(collection){
  var stack = ee.Image(collection.iterate(function(img, prev) {
    var score = img.select('score_mean')
    var index = ee.String(img.get('system:index'))
    score = score.rename(index)
    return ee.Image(prev).addBands(score);
  }, ee.Image(1)));

  stack = stack.select(ee.List.sequence(1, stack.bandNames().size().subtract(1)));
  return stack;
}


// create single image from collection
var scoreImage = collectionToImage(selectedExperiments);
scoreImage = scoreImage.addBands(reanalysis)
print(scoreImage)

// sample plot locations
var result = scoreImage.reduceRegions({
        reducer: ee.Reducer.min(),
        collection: SAMPLE,
        scale: 1,
        crs: 'EPSG:5070'
      });

print(result)



// Export
Export.table.toDrive({
  collection: result,
  description: 'exportTable',
  folder: 'ee-conditionassessment',
  // fileNamePrefix: fileName,
});


Map.addLayer(SAMPLE, {}, 'points');
Map.addLayer(scoreImage)

var style = {
  'Figure': [{
      featureType: 'all',
      stylers: [{ color: '#000000'}]
  }]
};

// Set map options.
Map.setOptions(null, style);
