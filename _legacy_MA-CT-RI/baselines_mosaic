// BASELINES MOSAIC 


var addYear = function(image) {
  var year = image.get('year_start')
  return image.addBands(ee.Image.constant(year)
    .rename('year')).int()
}

var rescaleSlopeAbs = function(image) {
  var slopeAbs = image.select('t')
    .abs()  // remove directionality
    .rename('abs_t')
  return image.addBands(slopeAbs)
}

var combinedScaled = function(image) {
  var scaled = image.select('t').abs()
    .divide(maxSlope)
    .add(image.select('rmse')
    .divide(maxRmse))
    .multiply(-1)
    .rename('combined_scaled')
  return image.addBands(scaled)
}

var OUTPUT_COLLECTION = 'projects/sites-project/baselines_v6-3_by_state'


var imageCollection = ee.ImageCollection(OUTPUT_COLLECTION)
      .filterMetadata('state', 'equals', 'PA')
      .filterMetadata('spectral_band', 'equals', 'tcg')
      .filterMetadata('time_series', 'equals', '16d')
      .filterMetadata('harmonics', 'equals', 'h13')
      .filterMetadata('WRS_PATH', 'equals', 16)
print(imageCollection)   

imageCollection = imageCollection.map(rescaleSlopeAbs)

var maxSlope = imageCollection.select('abs_t').reduce('max')
var maxRmse = imageCollection.select('rmse').reduce('max')

// build mosaic
imageCollection = imageCollection
  .map(combinedScaled)
  .map(addYear)

var mosaic = imageCollection.qualityMosaic('combined_scaled') 
print(mosaic)


/// map results
// Map.addLayer(mosaic.select('t'), {min:-5, max:5}, 'slope/trend', false)
// Map.addLayer(mosaic.select('rmse'), {min:0, max:1000}, 'rmse', false)
Map.addLayer(mosaic.select('year'), {min:2000, max:2019, palette:['blue', 'green', 'black', 'red']}, 'year', true)
// Map.addLayer(mosaic.select('combined_scaled'), {min:-1, max:0}, 'scaled', true)

// var bounds_geo = imageCollection.geometry().bounds()

// // export to asset
// Export.image.toAsset({
//   image: mosaic,
//   description: 'baselines_mosaic_' + YEAR_START + '-' + YEAR_END,
//   assetId: baseline_fn + '_baselines_mosaic_' + YEAR_START + '-' + YEAR_END,
//   region: bounds_geo,
//   crs: 'EPSG:5070',
//   scale: 30,
//   maxPixels: 1e13,
// })

var style = {
  'Figure': [{
      featureType: 'all',
      stylers: [{ color: '#000000'}]
  }]
};

// Set map options.
Map.setOptions(null, style);